<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Hemodynamics Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=SF+Pro+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1c;
            --bg-tertiary: #2c2c2e;
            --border-color: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #8d8d92;
            --accent-blue: #0A84FF;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .panel {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .panel-header {
            cursor: pointer;
            user-select: none;
            padding: 20px;
        }
        .panel-header:hover h3 {
             color: var(--accent-blue);
        }

        .panel-content {
            transition: max-height 0.5s cubic-bezier(0.25, 1, 0.5, 1), padding 0.5s cubic-bezier(0.25, 1, 0.5, 1), border 0.5s;
            overflow: hidden;
            max-height: 0;
            padding-left: 20px;
            padding-right: 20px;
            border-top: 1px solid transparent;
        }
        
        .panel:not(.collapsed) .panel-content {
             border-color: var(--border-color);
             padding-top: 20px;
             padding-bottom: 20px;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .param-item, .vital-item {
            background-color: var(--bg-primary);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .param-item:hover, .vital-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        
        .vital-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .mini-waveform {
            width: 100%;
            height: 40px;
            margin-bottom: 8px;
        }
        
        .vital-label { font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); }
        .vital-value { font-size: 1.8rem; line-height: 1; font-weight: 600; }
        .vital-unit { font-size: 0.8rem; margin-left: 4px; color: var(--text-secondary); }
        .param-label { font-size: 0.8rem; color: var(--text-secondary); display: block; margin-bottom: 4px; }
        .param-value { font-size: 1.1rem; font-weight: 600; }
        .param-unit { font-size: 0.75rem; color: var(--text-secondary); }

        .intervention-btn { 
            transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            border-radius: 12px;
            font-weight: 600;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }
        .intervention-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        input[type="range"] { -webkit-appearance:none; appearance:none; width:100%; height:6px; background:var(--bg-tertiary); border-radius:3px; outline:none; transition:background .3s; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:22px; height:22px; background:var(--text-primary); cursor:pointer; border-radius:50%; border: 4px solid var(--bg-tertiary); box-shadow: 0 0 0 1px var(--border-color); transition: transform 0.3s ease; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        .vexus-waveform canvas { background-color: #000; border-radius: 8px; }

        #message-box, #history-modal, #debrief-modal { 
            position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
            background-color: rgba(26, 26, 28, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color:white; padding:30px; border-radius:20px; z-index:1000; 
            display:none; box-shadow:0 12px 40px rgba(0,0,0,0.6); 
            border: 1px solid var(--border-color); max-width: 600px; text-align: left;
        }
        #message-box { top: 40px; transform: translateX(-50%); text-align: center; padding: 15px 25px;}

        #scenario-log-container { 
            background-color:#111111; border:1px solid var(--border-color); 
            border-radius:12px; padding:16px; height:280px; overflow-y:auto; 
            font-family: 'Menlo', 'Monaco', monospace; font-size:0.875rem;
        }
        
        .calculator-input { 
            background-color:var(--bg-tertiary); border:1px solid var(--border-color); 
            width:100%; padding:8px 12px; border-radius:8px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .calculator-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }
        
        .toggle-arrow { transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .panel.collapsed .toggle-arrow { transform: rotate(-90deg); }

        .main-header {
            padding-bottom: 24px;
        }
        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .action-button {
             background-color: var(--accent-blue);
             color: white;
             border-radius: 12px;
             font-weight: 600;
             transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
         .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(10, 132, 255, 0.3);
         }
    </style>
</head>
<body class="p-6 md:p-8">

    <div id="message-box"></div>
    <div id="history-modal">
        <h2 class="text-3xl font-bold mb-6 text-center">Clinical History</h2>
        <p id="history-modal-content" class="text-lg leading-relaxed text-gray-300"></p>
        <div class="text-center mt-8"><button id="close-history-modal" class="action-button py-3 px-6 text-lg">Start Scenario</button></div>
    </div>
    <div id="debrief-modal">
        <h2 class="text-3xl font-bold mb-6 text-center">Scenario Debrief</h2>
        <div id="debrief-modal-content" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        <div class="text-center mt-8"><button id="close-debrief-modal" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-lg">Return to Simulator</button></div>
    </div>

    <header class="main-header flex flex-col md:flex-row justify-between items-center mb-6">
        <h1 class="text-white">Hemodynamics</h1>
        <div class="mt-4 md:mt-0 flex items-center gap-4">
            <select id="scenario-select" class="bg-[#1c1c1e] border border-[#3a3a3c] rounded-xl p-3 text-white text-md">
                <option value="normal">Normal Physiology</option>
                <option value="hypovolemic">Hypovolemic Shock</option>
                <option value="cardiogenic">Cardiogenic Shock</option>
                <option value="adhf">ADHF - Wet & Cold</option>
                <option value="septic">Septic Shock (Warm)</option>
                <option value="rvFailure">RV Failure (PE)</option>
                <option value="ards">ARDS with Sepsis</option>
                <option value="tamponade">Cardiac Tamponade</option>
                <option value="hocm">HOCM with SAM</option>
                <option value="underdamped">Underdamped A-Line</option>
                <option value="overdamped">Overdamped A-Line</option>
            </select>
            <button id="end-scenario-btn" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 px-5 rounded-xl text-md">End & Debrief</button>
        </div>
    </header>

    <main class="flex flex-col gap-6">
        <!-- Vitals Panel (Full Width) -->
        <div id="core-vitals-panel" class="panel p-5">
            <h3 class="text-xl font-semibold mb-4 text-gray-300">Vitals</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="vital-item" style="color: #34C759;"><canvas id="ecg-chart" class="mini-waveform"></canvas><div class="vital-text"><span class="vital-label">ECG</span><span id="hr-display" class="vital-value">75</span></div></div>
                <div class="vital-item" style="color: #FF3B30;"><canvas id="art-chart" class="mini-waveform"></canvas><div class="vital-text"><span class="vital-label">ART</span><span id="art-display" class="vital-value">120/80</span></div></div>
                <div class="vital-item" style="color: #0A84FF;"><canvas id="spo2-chart" class="mini-waveform"></canvas><div class="vital-text"><span class="vital-label">SpO2</span><span id="spo2-display" class="vital-value">99</span><span class="vital-unit">%</span></div></div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Left Column: Data -->
            <div class="space-y-6">
                <div class="panel collapsed">
                    <div class="panel-header flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-300">Advanced Monitoring</h3><span class="toggle-arrow text-2xl">▼</span>
                    </div>
                    <div class="panel-content">
                        <div class="param-grid">
                            <div class="param-item"><span class="param-label">C.O.</span><span id="co-val" class="param-value">5.0</span><span class="param-unit">L/min</span></div>
                            <div class="param-item"><span class="param-label">C.I.</span><span id="ci-val" class="param-value">2.5</span><span class="param-unit">L/m²</span></div>
                            <div class="param-item"><span class="param-label">CVP</span><span id="cvp-val" class="param-value">6</span><span class="param-unit">mmHg</span></div>
                            <div class="param-item"><span class="param-label">PAP</span><span id="pap-val" class="param-value">25/10</span><span class="param-unit">mmHg</span></div>
                            <div class="param-item"><span class="param-label">PCWP</span><span id="pcwp-val" class="param-value">8</span><span class="param-unit">mmHg</span></div>
                            <div class="param-item"><span class="param-label">SvO2</span><span id="svo2-val" class="param-value">75</span><span class="param-unit">%</span></div>
                            <div class="param-item"><span class="param-label">PPV</span><span id="ppv-val" class="param-value">8</span><span class="param-unit">%</span></div>
                            <div class="param-item"><span class="param-label">SVV</span><span id="svv-val" class="param-value">9</span><span class="param-unit">%</span></div>
                            <div class="param-item"><span class="param-label">ELWI</span><span id="elwi-val" class="param-value">5</span><span class="param-unit">mL/kg</span></div>
                        </div>
                    </div>
                </div>
                <div class="panel collapsed">
                    <div class="panel-header flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-300">Echocardiography</h3><span class="toggle-arrow text-2xl">▼</span>
                    </div>
                    <div class="panel-content">
                        <div class="param-grid">
                            <div class="param-item"><span class="param-label">LV Function</span><span id="lv-func-val" class="param-value">Normal</span></div>
                            <div class="param-item"><span class="param-label">RV Function</span><span id="rv-func-val" class="param-value">Normal</span></div>
                            <div class="param-item"><span class="param-label">IVC</span><span id="ivc-val" class="param-value">Nml/>50%</span></div>
                            <div class="param-item"><span class="param-label">E/e'</span><span id="e-e-prime-val" class="param-value">8</span></div>
                            <div class="param-item"><span class="param-label">E/A Ratio</span><span id="ea-val" class="param-value">1.2</span></div>
                            <div class="param-item"><span class="param-label">Valves</span><span id="valve-val" class="param-value">Normal</span></div>
                            <div class="param-item"><span class="param-label">LVOT Grad</span><span id="lvotg-val" class="param-value">4</span><span class="param-unit">mmHg</span></div>
                        </div>
                    </div>
                </div>
                 <div class="panel collapsed">
                    <div class="panel-header flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-300">VExUS</h3><span class="toggle-arrow text-2xl">▼</span>
                    </div>
                     <div class="panel-content">
                        <div class="flex justify-around items-center">
                            <div class="text-center"><div class="vexus-waveform mb-1"><canvas id="hepatic-chart" width="80" height="50"></canvas></div><span class="text-xs">Hepatic</span></div>
                            <div class="text-center"><div class="vexus-waveform mb-1"><canvas id="portal-chart" width="80" height="50"></canvas></div><span class="text-xs">Portal</span></div>
                            <div class="text-center"><div class="vexus-waveform mb-1"><canvas id="renal-chart" width="80" height="50"></canvas></div><span class="text-xs">Renal</span></div>
                            <div class="text-center bg-blue-900/50 p-3 rounded-xl"><span class="param-label">VExUS</span><span id="vexus-grade-val" class="text-5xl font-bold">0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Controls -->
            <div class="space-y-6">
                <div class="panel collapsed"><div class="panel-header flex justify-between items-center"><h3 class="text-xl font-semibold">Interventions</h3><span class="toggle-arrow text-2xl">▼</span></div><div class="panel-content p-5"><div class="grid grid-cols-2 lg:grid-cols-3 gap-4"><button id="give-fluids" class="intervention-btn py-3 px-2">Fluids 500mL</button><button id="give-norepi" class="intervention-btn py-3 px-2">Norepinephrine</button><button id="give-dobutamine" class="intervention-btn py-3 px-2">Dobutamine</button><button id="give-ino" class="intervention-btn py-3 px-2">Inhaled NO</button><button id="diuresis-btn" class="intervention-btn py-3 px-2">Diuresis</button><button id="beta-blocker-btn" class="intervention-btn py-3 px-2">Beta Blocker</button><button id="thrombolysis-btn" class="intervention-btn py-3 px-2">Thrombolysis</button><button id="pericardiocentesis" class="intervention-btn py-3 px-2">Pericardiocentesis</button><button id="plr-test" class="intervention-btn py-3 px-2">PLR Test</button><button id="give-antibiotics" class="intervention-btn py-3 px-2">Antibiotics</button><button id="fast-flush-test" class="intervention-btn py-3 px-2">Fast Flush</button><button id="troubleshoot-aline" class="intervention-btn py-3 px-2">Troubleshoot A-Line</button></div></div></div>
                <div class="panel collapsed"><div class="panel-header flex justify-between items-center"><h3 class="text-xl font-semibold">Trainer Goal Controls</h3><span class="toggle-arrow text-2xl">▼</span></div><div class="panel-content p-5"><div class="flex items-center gap-4"><div class="flex-grow"><label class="text-sm mb-2 block text-gray-400">Target MAP (mmHg)</label><input id="target-map-input" type="number" class="calculator-input" placeholder="e.g., 65"></div><button id="activate-goal-btn" class="action-button self-end h-12 px-6">Activate</button></div><button id="hocm-override-btn" class="action-button mt-4 w-full py-3 hidden">Normalize HOCM</button></div></div>
                <div class="panel collapsed"><div class="panel-header flex justify-between items-center"><h3 class="text-xl font-semibold">Physiological Controls</h3><span class="toggle-arrow text-2xl">▼</span></div><div class="panel-content p-5"><div class="space-y-4"><div><label class="text-sm mb-2 block text-gray-400">Heart Rate (<span id="hr-slider-val">75</span>)</label><input type="range" id="hr-slider" min="30" max="200"></div><div><label class="text-sm mb-2 block text-gray-400">Contractility (<span id="contractility-slider-val">100</span>%)</label><input type="range" id="contractility-slider" min="10" max="150"></div><div><label class="text-sm mb-2 block text-gray-400">Preload (<span id="preload-slider-val">100</span>%)</label><input type="range" id="preload-slider" min="20" max="250"></div><div><label class="text-sm mb-2 block text-gray-400">SVR (<span id="svr-slider-val">1000</span>)</label><input type="range" id="svr-slider" min="400" max="2500"></div><div><label class="text-sm mb-2 block text-gray-400">PVR (<span id="pvr-slider-val">150</span>)</label><input type="range" id="pvr-slider" min="50" max="800"></div></div></div></div>
                <div class="panel collapsed"><div class="panel-header flex justify-between items-center"><h3 class="text-xl font-semibold">Ventilator</h3><span class="toggle-arrow text-2xl">▼</span></div><div class="panel-content p-5"><div class="grid grid-cols-2 gap-6"><div><h4 class="font-bold text-center text-gray-400">Settings</h4><div class="space-y-4 mt-3"><div><label class="text-sm mb-2 block text-gray-400">PEEP (<span id="peep-slider-val">5</span>)</label><input type="range" id="peep-slider" min="0" max="24"></div><div><label class="text-sm mb-2 block text-gray-400">Tidal Vol (<span id="tv-slider-val">450</span>)</label><input type="range" id="tv-slider" min="200" max="800"></div><div><label class="text-sm mb-2 block text-gray-400">Resp Rate (<span id="rr-slider-val">12</span>)</label><input type="range" id="rr-slider" min="8" max="35"></div></div></div><div><h4 class="font-bold text-center text-gray-400">Mechanics</h4><div class="param-grid mt-3 grid-cols-2"><div class="param-item"><span class="param-label">PIP</span><span id="pip-val" class="param-value">25</span></div><div class="param-item"><span class="param-label">Pplat</span><span id="pplat-val" class="param-value">20</span></div><div class="param-item"><span class="param-label">Driving P</span><span id="dp-val" class="param-value">15</span></div><div class="param-item"><span class="param-label">Compliance</span><span id="comp-val" class="param-value">30</span></div><div class="param-item col-span-2"><span class="param-label">Resistance</span><span id="res-val" class="param-value">10</span></div></div></div></div></div></div>
            </div>

            <!-- Right Column: Tools -->
            <div class="space-y-6">
                 <div class="panel collapsed">
                    <div class="panel-header flex justify-between items-center"><h3 class="text-xl font-semibold">Calculator</h3><span class="toggle-arrow text-2xl">▼</span></div>
                    <div class="panel-content p-5">
                        <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                            <div><label class="text-gray-400 mb-1 block">MAP</label><input id="calc-map" type="number" class="calculator-input"></div>
                            <div><label class="text-gray-400 mb-1 block">CVP</label><input id="calc-cvp" type="number" class="calculator-input"></div>
                            <div><label class="text-gray-400 mb-1 block">Mean PAP</label><input id="calc-mpap" type="number" class="calculator-input"></div>
                            <div><label class="text-gray-400 mb-1 block">PCWP</label><input id="calc-pcwp" type="number" class="calculator-input"></div>
                            <div class="col-span-2"><label class="text-gray-400 mb-1 block">Cardiac Output</label><input id="calc-co" type="number" class="calculator-input"></div>
                            <div class="col-span-2 mt-3"><button id="calculate-btn" class="w-full action-button py-3">Calculate</button></div>
                            <div class="param-item mt-2"><span class="param-label">SVR</span><span id="calc-svr-out" class="param-value">-</span><span class="param-unit">dyn·s/cm⁵</span></div>
                            <div class="param-item mt-2"><span class="param-label">PVR</span><span id="calc-pvr-out" class="param-value">-</span><span class="param-unit">dyn·s/cm⁵</span></div>
                        </div>
                    </div>
                </div>
                 <div class="panel p-5">
                    <h3 class="text-xl font-semibold mb-4 text-gray-300">Scenario Log</h3>
                    <div id="scenario-log-container"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
    // --- DOM ELEMENT SELECTION ---
    const scenarioSelect = document.getElementById('scenario-select');
    const historyModal = document.getElementById('history-modal');
    const historyContent = document.getElementById('history-modal-content');
    const closeHistoryBtn = document.getElementById('close-history-modal');
    const debriefModal = document.getElementById('debrief-modal');
    const debriefContent = document.getElementById('debrief-modal-content');
    const closeDebriefBtn = document.getElementById('close-debrief-modal');
    const messageBox = document.getElementById('message-box');
    const logContainer = document.getElementById('scenario-log-container');
    
    const displays = {
        hr: document.getElementById('hr-display'), art: document.getElementById('art-display'), spo2: document.getElementById('spo2-display'), co: document.getElementById('co-val'), ci: document.getElementById('ci-val'), cvp: document.getElementById('cvp-val'), pap: document.getElementById('pap-val'), pcwp: document.getElementById('pcwp-val'), svo2: document.getElementById('svo2-val'), ppv: document.getElementById('ppv-val'), svv: document.getElementById('svv-val'), elwi: document.getElementById('elwi-val'), lvFunc: document.getElementById('lv-func-val'), rvFunc: document.getElementById('rv-func-val'), ivc: document.getElementById('ivc-val'), eePrime: document.getElementById('e-e-prime-val'), vexusGrade: document.getElementById('vexus-grade-val'), eaRatio: document.getElementById('ea-val'), valveStatus: document.getElementById('valve-val'), lvotg: document.getElementById('lvotg-val'), pip: document.getElementById('pip-val'), pplat: document.getElementById('pplat-val'), dp: document.getElementById('dp-val'), compliance: document.getElementById('comp-val'), resistance: document.getElementById('res-val'),
    };
    
    const sliders = {
        hr: document.getElementById('hr-slider'), contractility: document.getElementById('contractility-slider'), preload: document.getElementById('preload-slider'), svr: document.getElementById('svr-slider'), pvr: document.getElementById('pvr-slider'), peep: document.getElementById('peep-slider'), tidalVolume: document.getElementById('tv-slider'), respiratoryRate: document.getElementById('rr-slider'),
    };
    const sliderVals = {
        hr: document.getElementById('hr-slider-val'), contractility: document.getElementById('contractility-slider-val'), preload: document.getElementById('preload-slider-val'), svr: document.getElementById('svr-slider-val'), pvr: document.getElementById('pvr-slider-val'), peep: document.getElementById('peep-slider-val'), tidalVolume: document.getElementById('tv-slider-val'), respiratoryRate: document.getElementById('rr-slider-val'),
    };
    
    const buttons = {
        fluids: document.getElementById('give-fluids'), norepi: document.getElementById('give-norepi'), dobutamine: document.getElementById('give-dobutamine'), ino: document.getElementById('give-ino'), diuresis: document.getElementById('diuresis-btn'), betaBlocker: document.getElementById('beta-blocker-btn'), thrombolysis: document.getElementById('thrombolysis-btn'), antibiotics: document.getElementById('give-antibiotics'), pericardiocentesis: document.getElementById('pericardiocentesis'), endScenario: document.getElementById('end-scenario-btn'), calculate: document.getElementById('calculate-btn'), activateGoal: document.getElementById('activate-goal-btn'),
        plr: document.getElementById('plr-test'),
        fastFlush: document.getElementById('fast-flush-test'),
        troubleshootAline: document.getElementById('troubleshoot-aline'),
        hocmOverride: document.getElementById('hocm-override-btn'),
    };
    const inputs = {
        targetMAP: document.getElementById('target-map-input'),
    };

    // --- CHART & SIMULATION STATE ---
    let charts = {};
    let simulationState = {};
    let simulationInterval;
    let scenarioLog = [];
    let currentScenarioName = '';
    const BSA = 2.0;
    const SIMULATION_TICK_MS = 100;
    let lastGenerated = { hr: 0, systolic: 0, diastolic: 0, vexusGrade: -1 };
    let isFlushing = false;

    // --- SCENARIO DEFINITIONS ---
    const baseSettings = { spo2: 99, peep: 5, tidalVolume: 450, respiratoryRate: 12, compliance: 50, resistance: 5, pericardialFluid: 0, infection: 0, antibioticsOnBoard: false, valveStatus: 'Normal', eaRatio: 1.2, lvotg: 4, targetMAP: null, goalSeeking: false, norepiDose: 0, dobutamineDose: 0, dampingStatus: 'optimal'};
    const scenarios = {
        normal: { ...baseSettings, hr: 75, contractility: 100, preload: 100, svr: 1200, pvr: 150 },
        hypovolemic: { ...baseSettings, hr: 130, contractility: 110, preload: 20, svr: 2000, pvr: 180, respiratoryRate: 18, eaRatio: 1.5, spo2: 96 },
        cardiogenic: { ...baseSettings, hr: 115, contractility: 15, preload: 200, svr: 2300, pvr: 320, spo2: 88, peep: 8, compliance: 40, valveStatus: 'MR (Mild)', eaRatio: 0.6 },
        adhf: { ...baseSettings, hr: 95, contractility: 25, preload: 230, svr: 1800, pvr: 380, spo2: 89, peep: 10, compliance: 35, valveStatus: 'MR (Mod)', eaRatio: 0.5 },
        septic: { ...baseSettings, hr: 125, contractility: 70, preload: 70, svr: 400, pvr: 200, spo2: 92, peep: 6, compliance: 60, infection: 1, eaRatio: 1.0 },
        rvFailure: { ...baseSettings, hr: 120, contractility: 70, preload: 200, svr: 1100, pvr: 800, spo2: 86, peep: 8, compliance: 45, valveStatus: 'TR (Severe)', eaRatio: 0.7 },
        ards: { ...baseSettings, hr: 110, contractility: 90, preload: 110, svr: 900, pvr: 350, spo2: 85, peep: 14, tidalVolume: 350, compliance: 25, infection: 0.5 },
        tamponade: { ...baseSettings, hr: 130, contractility: 90, preload: 100, svr: 1700, pvr: 250, spo2: 94, pericardialFluid: 130, valveStatus: 'Effusion, RA/RV Collapse'},
        hocm: { ...baseSettings, hr: 80, contractility: 140, preload: 80, svr: 1200, pvr: 160, lvotg: 70, valveStatus: 'SAM / MR', eaRatio: 0.7, spo2: 95 },
        underdamped: { ...baseSettings, hr: 85, contractility: 100, preload: 100, svr: 1200, pvr: 150, dampingStatus: 'underdamped' },
        overdamped: { ...baseSettings, hr: 85, contractility: 100, preload: 100, svr: 1200, pvr: 150, dampingStatus: 'overdamped' },
    };
    const scenarioHistories = {
        normal: "A stable patient in the ICU for observation post-procedure. No acute complaints.",
        hypovolemic: "A 45-year-old male involved in a motor vehicle collision arrives with signs of internal bleeding.",
        cardiogenic: "A 68-year-old female presents with crushing chest pain, diaphoresis, and shortness of breath. ECG shows an anterior STEMI.",
        adhf: "A 72-year-old with a history of ischemic cardiomyopathy presents with 3 days of worsening dyspnea, orthopnea, and lower extremity edema.",
        septic: "An 80-year-old nursing home resident is sent to the ED for altered mental status and fever. Urine is cloudy and foul-smelling.",
        rvFailure: "A 55-year-old who recently underwent a hip replacement develops sudden-onset severe dyspnea and chest pain.",
        ards: "A 60-year-old patient with pancreatitis develops rapidly worsening hypoxemia and bilateral infiltrates on chest X-ray.",
        tamponade: "A 34-year-old status-post cardiac surgery day 2 develops sudden hypotension and tachycardia. Chest tube output has ceased.",
        hocm: "A 22-year-old athlete collapses during practice. He is brought to the ED with hypotension and a harsh systolic murmur.",
        underdamped: "A stable patient is admitted for monitoring. The arterial line waveform appears 'whippy' with a high systolic reading.",
        overdamped: "A stable patient is admitted for monitoring. The arterial line waveform appears blunted and the pulse pressure is narrow.",
    };
    
    // --- WAVEFORM & CHART LOGIC ---
    const getEcgData = hr => { const p=[0,.1,0,0], q=[0,-.2], r=[.8,1], s=[-.4,0], t=[0,.3,.2,0]; const c=[...p,...q,...r,...s,...t]; const bl=(60/hr)*10; const fl=Math.max(2,Math.floor(bl-c.length)); const f=Array(fl).fill(0); return [...c,...f]; };
    const getArtData = (sys, dias, hr, dampingStatus = 'optimal') => {
        let pp = sys - dias;
        let upstroke = Array.from({ length: 3 }, (_, i) => dias + (pp / 3) * (i + 1));
        let peak, downstroke, notch, rise;

        switch (dampingStatus) {
            case 'underdamped':
                peak = [sys, sys * 0.95];
                downstroke = Array.from({ length: 4 }, (_, i) => sys * 0.9 - (pp * 0.4 / 4) * i);
                let notchBase = downstroke[downstroke.length - 1];
                notch = [notchBase * 0.9, notchBase * 1.15, notchBase * 0.95, notchBase * 1.05]; // Exaggerated ringing
                rise = Array.from({ length: 2 }, (_, i) => notch[notch.length-1] - ((notch[notch.length-1] - dias) / 2) * i);
                break;
            case 'overdamped':
                let bluntedSys = dias + pp * 0.8;
                upstroke = [dias, dias + pp * 0.3, dias + pp*0.6, bluntedSys];
                peak = [bluntedSys];
                downstroke = Array.from({ length: 6 }, (_, i) => bluntedSys - ((bluntedSys - dias) / 6) * (i + 1));
                notch = []; // No notch
                rise = [];
                break;
            default: // Optimal
                peak = [sys, sys * 0.95];
                downstroke = Array.from({ length: 5 }, (_, i) => sys * 0.9 - (pp * 0.4 / 5) * i);
                let base = downstroke[downstroke.length - 1];
                notch = [base * 0.95, base * 1.05];
                rise = Array.from({ length: 2 }, (_, i) => notch[1] - ((notch[1] - dias) / 2) * i);
                break;
        }

        const coreWave = [...upstroke, ...peak, ...downstroke, ...notch, ...rise];
        const beatLength = (60 / hr) * 10;
        const fillLength = Math.max(2, Math.floor(beatLength - coreWave.length));
        const fill = Array(fillLength).fill(dias);
        return [...coreWave, ...fill];
    };
    const getSpo2Data = hr => { const w=[0,.2,.5,.8,1,.9,.6,.3,.1,0]; const bl=(60/hr)*10; const fl=Math.max(2,Math.floor(bl-w.length)); const f=Array(fl).fill(0); return[...w,...f]; };
    const vexusWaveforms = { hepatic:{g0:[0,-1.2,0,.6,0,-1.2,0,.6,0,0],g1:[0,-.8,0,.8,0,-.8,0,.8,0,0],g2:[0,.4,0,-1,0,.4,0,-1,0,0],g3:[0,1,0,.2,0,1,0,.2,0,0]}, portal:{g0:[1,1,1,1,1,1,1,1,1,1],g1:[1,1.1,1,.9,1,1.1,1,.9,1,1],g2:[1,1.3,1,.7,1,1.3,1,.7,1,1],g3:[1,1.6,.8,.4,1,1.6,.8,.4,1,1]}, renal:{g0:[1,1,1,1,1,1,1,1,1,1],g1:[1,1,.9,1,1,1,.9,1,1,1],g2:[1,.8,.6,1,1,.8,.6,1,1,1],g3:[1,.5,-.2,.5,1,.5,-.2,.5,1,1]} };
    const getVexusData = (type,grade) => { grade=Math.min(3,Math.max(0,Math.round(grade))); return vexusWaveforms[type][`g${grade}`]; };
    
    function createChart(canvasId, color, sMax, sMin) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const isVexus = canvasId.includes('hepatic') || canvasId.includes('portal') || canvasId.includes('renal');
        return new Chart(ctx, { type: 'line', data: { labels: Array(isVexus ? 10 : 100).fill(''), datasets: [{ data: [], borderColor: color, borderWidth: isVexus ? 2.5 : 2, pointRadius: 0, tension: 0.4 }] }, options: { animation: {duration: 0}, scales: { y: {display:false, suggestedMin: sMin, suggestedMax: sMax }, x: {display: false}}, plugins: {legend: {display:false}, tooltip:{enabled:false}}, layout: {padding: {top:2,bottom:2}}} });
    }

    function setupCharts() {
        Object.values(charts).forEach(chart => chart.destroy());
        charts.ecg = createChart('ecg-chart', '#34C759', 2, -1);
        charts.art = createChart('art-chart', '#FF3B30', 200, 40);
        charts.spo2 = createChart('spo2-chart', '#0A84FF', 1.2, -0.2);
        charts.hepatic = createChart('hepatic-chart', '#0A84FF', 1.5, -1.5);
        charts.portal = createChart('portal-chart', '#FFCC00', 2, 0);
        charts.renal = createChart('renal-chart', '#FF3B30', 2, -0.5);
    }
    
    let waveformDataPoints = {}; let dataIndex=0;
    function updateWaveforms() {
        if (isFlushing) return;
        const state=simulationState; 
        const trueParams=calculateDerivedParams(state);
        const displayedParams = getDisplayedParams(trueParams, state.dampingStatus);

        if(Math.abs(displayedParams.bp.systolic-lastGenerated.systolic)>5 || !waveformDataPoints.ecg){
            waveformDataPoints.ecg=getEcgData(displayedParams.hr); 
            waveformDataPoints.art=getArtData(displayedParams.bp.systolic, displayedParams.bp.diastolic, displayedParams.hr, state.dampingStatus);
            waveformDataPoints.spo2=getSpo2Data(displayedParams.hr);
            lastGenerated={hr:displayedParams.hr, systolic:displayedParams.bp.systolic, diastolic:displayedParams.bp.diastolic, vexusGrade:lastGenerated.vexusGrade};
        }
        if(trueParams.vexusGrade !== lastGenerated.vexusGrade) {
            waveformDataPoints.hepatic=getVexusData('hepatic',trueParams.vexusGrade); waveformDataPoints.portal=getVexusData('portal',trueParams.vexusGrade);
            waveformDataPoints.renal=getVexusData('renal',trueParams.vexusGrade);
            charts.hepatic.data.datasets[0].data=waveformDataPoints.hepatic; charts.portal.data.datasets[0].data=waveformDataPoints.portal;
            charts.renal.data.datasets[0].data=waveformDataPoints.renal;
            charts.hepatic.update('none'); charts.portal.update('none'); charts.renal.update('none');
            lastGenerated.vexusGrade = trueParams.vexusGrade;
        }
        ['ecg','art','spo2'].forEach(name=>{ if(charts[name] && waveformDataPoints[name]?.length>0){ const chart=charts[name]; chart.data.datasets[0].data.push(waveformDataPoints[name][dataIndex%waveformDataPoints[name].length]); if(chart.data.datasets[0].data.length > 100) chart.data.datasets[0].data.shift(); chart.update('none');}});
        dataIndex++;
    }

    // --- PHYSIOLOGICAL ENGINE ---
    function calculateDerivedParams(state) {
        const tamponade=1-(state.pericardialFluid/150);
        const peepEffect = state.peep > 8 ? (state.peep - 8) * 4 : 0;
        const effectivePreload = state.preload - peepEffect;
        
        // Capped preload effect: benefit of preload plateaus > 100%
        let preloadFactor = Math.min(1.0, effectivePreload / 100);
        
        const afterloadFactor=1-((state.svr-1200)/5000);
        
        // Base Stroke Volume - HR factor removed from here
        let sv = 80 * (state.contractility / 100) * preloadFactor * afterloadFactor * tamponade;
        
        if(currentScenarioName === 'rvFailure') { sv *= (1 - (state.pvr - 150) / 900); }
        
        // Refined HOCM LOGIC
        let hocm_gradient = 0;
        if(state.lvotg > 10 || currentScenarioName === 'hocm') {
            hocm_gradient = state.lvotg + (150 - effectivePreload) * 0.6 + (state.contractility - 100) * 0.9 + (1200 - state.svr) * 0.05;
            hocm_gradient = Math.max(4, hocm_gradient);
            sv *= (1 - hocm_gradient / 150); // Obstruction has a very significant impact on SV
        }

        sv = Math.max(10,sv);
        // CO is now a direct product of the calculated SV and current HR
        let co=(sv*state.hr)/1000;
        let cvp=(effectivePreload/100)*8 + (state.pvr-150)/40; if(state.pericardialFluid>0) cvp=state.pericardialFluid/5+2; cvp=Math.max(1,cvp);
        let map=(co*state.svr)/80+cvp;
        let pp = sv * 1.0; 
        pp=Math.max(10,pp*tamponade);
        let systolic=map+(2/3*pp); let diastolic=map-(1/3*pp); if(diastolic<30){diastolic=30;systolic=diastolic+pp;}
        let pcwp=(effectivePreload/100)*10-((state.contractility-100)/10); if(state.pericardialFluid>0) pcwp=cvp*.95; pcwp=Math.max(3,pcwp); let pap_d=pcwp+2; let pap_s=((co*state.pvr)/80)+pap_d; if(state.pericardialFluid>0){pap_d=cvp;pap_s=cvp+5;}
        const ppv=25-(effectivePreload/10); const svv=28-(effectivePreload/9); const elwi=3+(effectivePreload/25)-(state.contractility/50)+((state.pvr-150)/100);
        const lvFunc=state.contractility<50?'Severe↓':state.contractility > 120 ? 'Hyperdynamic' : 'Normal';
        const rvPvrEffect=(state.pvr-150)/450; const rvFunc=rvPvrEffect>.7?'Severe↓':rvPvrEffect>.4?'Mild↓':'Normal';
        const ivc=effectivePreload<60?'Small/>50%':effectivePreload>150?'Plethoric/<20%':'Nml/>50%'; const eePrime=8+(pcwp-8)*.8;
        const vexusGrade=cvp<8?0:cvp<12?1:cvp<16?2:3; const svo2=75+(co-5)*5-(state.hr-75)*.1;
        const pplat = (state.tidalVolume / state.compliance) + state.peep; const pip = pplat + (state.tidalVolume / 300) * state.resistance; const dp = pplat - state.peep;
        return { co:Math.max(1,co),ci:Math.max(.5,co/BSA),cvp:Math.max(1,cvp),pap:{systolic:pap_s,diastolic:pap_d},pcwp:Math.max(2,pcwp),svo2:Math.min(95,Math.max(30,svo2)),bp:{systolic,diastolic,map},hr:state.hr,spo2:state.spo2,peep:state.peep,ppv:Math.min(40,Math.max(3,ppv)),svv:Math.min(45,Math.max(4,svv)),elwi:Math.min(30,Math.max(3,elwi)),lvFunc,rvFunc,ivc,eePrime,vexusGrade,lvotg:hocm_gradient,pip,pplat,dp,compliance:state.compliance,resistance:state.resistance,eaRatio:state.eaRatio,valveStatus:state.valveStatus};
    }
    
    // --- UI & STATE UPDATES ---
    function getDisplayedParams(trueParams, dampingStatus) {
        let displayedBP = { ...trueParams.bp };
        if (dampingStatus === 'underdamped') {
            displayedBP.systolic *= 1.20;
            displayedBP.diastolic *= 0.95;
        } else if (dampingStatus === 'overdamped') {
            displayedBP.systolic *= 0.90;
            displayedBP.diastolic *= 1.05;
        }
        return { ...trueParams, bp: displayedBP };
    }

    function updateDisplay() {
        const trueParams = calculateDerivedParams(simulationState);
        const displayedParams = getDisplayedParams(trueParams, simulationState.dampingStatus);

        Object.keys(displays).forEach(key => { 
            if(displays[key]){
                const paramSource = (key === 'art') ? displayedParams : trueParams;
                if(typeof paramSource[key]==='number'){
                    displays[key].textContent=paramSource[key].toFixed(key==='co'||key==='ci'||key==='eaRatio'?1:0)
                } else if(key==='art'){
                    displays.art.innerHTML=`${Math.round(paramSource.bp.systolic)}/${Math.round(paramSource.bp.diastolic)} <span class="vital-unit">(${Math.round(paramSource.bp.map)})</span>`
                } else if(typeof paramSource[key]==='object'&&key==='pap'){
                    displays[key].textContent=`${Math.round(paramSource.pap.systolic)}/${Math.round(paramSource.pap.diastolic)}`
                } else {
                    displays[key].textContent=paramSource[key];
                }
            }
        });
        Object.keys(sliders).forEach(key => { if(sliders[key]){sliders[key].value=simulationState[key];sliderVals[key].textContent=Math.round(simulationState[key]);}});
    }

    function simulationTick() {
        // Core physiological changes happen here, independent of display artifacts
        if (simulationState.infection > 0) {
            const infectionDecayRate = simulationState.antibioticsOnBoard ? 0.005 : 0.0005;
            simulationState.infection = Math.max(0, simulationState.infection - infectionDecayRate);
            simulationState.svr += (1200 - simulationState.svr) * 0.005;
        }
        updateDisplay(); 
        updateWaveforms();
    }
    
    function logAction(type, message, data = {}) {
        const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        scenarioLog.push({ timestamp, type, message, data });
        const p = document.createElement('p');
        p.className = 'log-entry';
        p.innerHTML = `<span class="text-gray-500">${timestamp}</span> <span class="text-gray-200">> ${message}</span>`;
        logContainer.appendChild(p);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    // --- INTERVENTIONS & ACTIONS ---
    function applyIntervention(effect, duration, message, logData) { 
        showMessage(message, duration || 3000); 
        logAction('intervention', message, logData); 
        for(const p in effect){simulationState[p]+=effect[p];} 
        document.getElementById('core-vitals-panel').scrollIntoView({ behavior: 'smooth', block: 'center' }); 
        if(duration>0) setTimeout(()=>{for(const p in effect){simulationState[p]-=effect[p];}},duration); 
    }
    function showMessage(text, duration) { messageBox.textContent=text; messageBox.style.display='block'; setTimeout(()=>messageBox.style.display='none',duration); }
    
    function generateDebrief() {
        if (!simulationInterval) return; 
        clearInterval(simulationInterval); 
        simulationInterval = null; 
        logAction("system", "Scenario Ended. Generating Debrief...");
        
        const idealActionsMap = {
            hypovolemic: ["Fluids", "Norepinephrine"], cardiogenic: ["Norepinephrine", "Dobutamine", "Diuresis"], adhf: ["Diuresis", "Dobutamine"], septic: ["Fluids", "Norepinephrine", "Antibiotics"], rvFailure: ["Thrombolysis", "Norepinephrine"], ards: ["Antibiotics"], tamponade: ["Pericardiocentesis", "Fluids"], hocm: ["Beta Blocker", "Fluids"],
            underdamped: ["Fast Flush", "Troubleshoot A-Line"], overdamped: ["Fast Flush", "Troubleshoot A-Line"],
        };
        
        const userActions = scenarioLog.filter(l => l.type === 'intervention').map(l => l.data.name);
        const ideal = idealActionsMap[currentScenarioName] || [];
        const correct = ideal.filter(action => userActions.includes(action));
        const missed = ideal.filter(action => !userActions.includes(action));
        const incorrect = userActions.filter(action => !ideal.includes(action));

        let summaryHTML = `<div><h4 class="text-xl font-bold my-2 text-white">Summary</h4><p class="text-gray-300">You performed <strong>${correct.length}</strong> correct actions and <strong>${incorrect.length}</strong> incorrect/unnecessary action(s). You missed <strong>${missed.length}</strong> key intervention(s).</p></div>`
        let userActionsHTML = '<div><h4 class="text-xl font-bold my-2 text-white">Your Actions</h4><div class="text-sm text-gray-400">' + (scenarioLog.filter(l => l.type === 'intervention').map(l => `<p>${l.message}</p>`).join('') || '<p>No actions logged.</p>') + '</div></div>';
        let idealActionsHTML = '<div><h4 class="text-xl font-bold my-2 text-green-400">Ideal Management</h4><div class="text-gray-300">' + (ideal.length > 0 ? ideal.map(a => `<p>- ${a}</p>`).join('') : '<p>None</p>') + '</div></div>';
        let feedbackHTML = '<div><h4 class="text-xl font-bold my-2 text-yellow-400">Feedback</h4>';
        if(missed.length > 0) feedbackHTML += `<p class="text-red-400">You missed these key interventions: ${missed.join(', ')}.</p>`;
        if(incorrect.length > 0) feedbackHTML += `<p class="text-orange-400">These actions may have been unnecessary or harmful: ${incorrect.join(', ')}.</p>`;
        if(missed.length === 0 && incorrect.length === 0) feedbackHTML += '<p class="text-green-400">Excellent! You performed all the ideal actions for this scenario.</p>';
        feedbackHTML += '</div>';

        debriefContent.innerHTML = summaryHTML + userActionsHTML + idealActionsHTML + feedbackHTML;
        debriefModal.style.display = 'block';
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        scenarioSelect.addEventListener('change', e => loadScenario(e.target.value));
        closeHistoryBtn.addEventListener('click', () => historyModal.style.display = 'none');
        closeDebriefBtn.addEventListener('click', () => debriefModal.style.display = 'none');
        buttons.endScenario.addEventListener('click', generateDebrief);
        Object.keys(sliders).forEach(key => { if (sliders[key]) { sliders[key].addEventListener('input', e => { simulationState[key] = parseFloat(e.target.value); logAction('control',`Manual Override: Set ${key} to ${Math.round(e.target.value)}`); }); }});
        
        buttons.fluids.addEventListener('click', () => applyIntervention({ preload: 40 }, 0, "Administered Fluids 500mL", {name: "Fluids"}));
        buttons.norepi.addEventListener('click', () => {
            simulationState.norepiDose = (simulationState.norepiDose || 0) + 1;
            applyIntervention({ svr: 100, contractility: 2 }, 0, `Norepinephrine increased to Level ${simulationState.norepiDose}`, {name: "Norepinephrine"});
        });
        buttons.dobutamine.addEventListener('click', () => {
            simulationState.dobutamineDose = (simulationState.dobutamineDose || 0) + 1;
            applyIntervention({ contractility: 8, svr: -25, hr: 4 }, 0, `Dobutamine increased to Level ${simulationState.dobutamineDose}`, {name: "Dobutamine"});
        });
        buttons.ino.addEventListener('click', () => applyIntervention({ pvr: -250 }, 0, "Started Inhaled NO at 20 ppm", {name: "Inhaled NO"}));
        buttons.diuresis.addEventListener('click', () => applyIntervention({ preload: -50 }, 0, "Initiated Diuresis (Furosemide 40mg IV)", {name: "Diuresis"}));
        buttons.betaBlocker.addEventListener('click', () => applyIntervention({ hr: -15, contractility: -40}, 0, "Administered Beta Blocker (Metoprolol 5mg IV)", {name: "Beta Blocker"}));
        buttons.thrombolysis.addEventListener('click', () => { if (currentScenarioName === 'rvFailure') { applyIntervention({ pvr: -600, svr: -300 }, 0, "Administered Thrombolysis (tPA Bolus)", {name: "Thrombolysis"}); } else { showMessage("Thrombolysis not indicated.", 3000); }});
        buttons.plr.addEventListener('click', () => { const co=calculateDerivedParams(simulationState).co; applyIntervention({ preload: 30 }, 20000, "Performing PLR Test", {name: "PLR"}); setTimeout(()=>{ const nCO=calculateDerivedParams(simulationState).co; const ch=((nCO-co)/co)*100; showMessage(`PLR Test: CO change ${ch.toFixed(1)}%`, 4000); logAction('result', `PLR result: ${ch.toFixed(1)}% change in CO.`);},10000);});
        buttons.pericardiocentesis.addEventListener('click', () => { if(simulationState.pericardialFluid > 0) { applyIntervention({pericardialFluid: -simulationState.pericardialFluid}, 0, "Performed Pericardiocentesis", {name: "Pericardiocentesis"}); } else { showMessage("No pericardial fluid to drain.", 3000); }});
        buttons.antibiotics.addEventListener('click', () => { 
            if(simulationState.infection>0) {
                simulationState.antibioticsOnBoard = true;
                logAction("intervention", "Administered Antibiotics", {name: "Antibiotics"});
                showMessage("Antibiotics administered. Infection will resolve faster.", 3000);
            } else {
                showMessage("Antibiotics not indicated.", 3000);
            }
        });
        buttons.fastFlush.addEventListener('click', () => {
            if (isFlushing) return;
            isFlushing = true;
            logAction('intervention', 'Performing Fast Flush Test', {name: "Fast Flush"});
            const chart = charts.art;
            const originalData = [...chart.data.datasets[0].data];
            
            let flushData = Array(20).fill(300); // The flush
            let postFlush;
            let resultMsg = "";
            switch(simulationState.dampingStatus) {
                case 'underdamped':
                    postFlush = [100, 150, 60, 130, 70, 110, 80, 90, 85];
                    resultMsg = "Fast flush test shows UNDERDAMPING (>2 oscillations).";
                    break;
                case 'overdamped':
                    postFlush = [200, 150, 120, 100, 90];
                    resultMsg = "Fast flush test shows OVERDAMPING (<1.5 oscillations).";
                    break;
                default:
                    postFlush = [100, 150, 75, 110, 85];
                    resultMsg = "Fast flush test shows OPTIMAL DAMPING (1.5-2 oscillations).";
                    break;
            }
            const testData = [...flushData, ...postFlush];
            const finalData = [...originalData.slice(testData.length), ...testData];
            chart.data.datasets[0].data = finalData;
            chart.update();

            setTimeout(() => {
                showMessage(resultMsg, 4000);
                logAction('result', resultMsg);
                isFlushing = false;
            }, 1000);
        });

        buttons.troubleshootAline.addEventListener('click', () => {
            logAction('intervention', 'Troubleshooting A-Line system', {name: "Troubleshoot A-Line"});
            if(simulationState.dampingStatus !== 'optimal') {
                simulationState.dampingStatus = 'optimal';
                showMessage("A-Line system checked. Damping is now optimal.", 3000);
            } else {
                showMessage("A-Line system is already optimally damped.", 3000);
            }
        });
        
        buttons.hocmOverride.addEventListener('click', () => {
            if (currentScenarioName === 'hocm') {
                logAction('intervention', 'HOCM pathology normalized by trainer.', {name: "Normalize HOCM"});
                simulationState.lvotg = scenarios.normal.lvotg;
                simulationState.contractility = scenarios.normal.contractility;
                showMessage("HOCM pathology has been normalized.", 3000);
            }
        });

        buttons.calculate.addEventListener('click', () => {
            const map=parseFloat(document.getElementById('calc-map').value); const cvp=parseFloat(document.getElementById('calc-cvp').value); const mpap=parseFloat(document.getElementById('calc-mpap').value); const pcwp=parseFloat(document.getElementById('calc-pcwp').value); const co=parseFloat(document.getElementById('calc-co').value);
            const svr_out=document.getElementById('calc-svr-out'); const pvr_out=document.getElementById('calc-pvr-out');
            if(map&&cvp&&co&&co>0){ svr_out.textContent = (80*(map-cvp)/co).toFixed(0); } else { svr_out.textContent = '-'; }
            if(mpap&&pcwp&&co&&co>0){ pvr_out.textContent = (80*(mpap-pcwp)/co).toFixed(0); } else { pvr_out.textContent = '-'; }
        });

        document.querySelectorAll('.panel-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const panel = header.parentElement;
                panel.classList.toggle('collapsed');
                if (!panel.classList.contains('collapsed')) {
                    content.style.maxHeight = content.scrollHeight + "px";
                } else {
                    content.style.maxHeight = null;
                } 
            });
        });
    }

    // --- INITIALIZATION ---
    function loadScenario(scenarioName) {
        if (simulationInterval) clearInterval(simulationInterval);
        currentScenarioName = scenarioName;
        simulationState = JSON.parse(JSON.stringify(scenarios[scenarioName]));
        
        historyContent.textContent = scenarioHistories[scenarioName];
        historyModal.style.display = 'block';

        waveformDataPoints = {}; lastGenerated = {hr:0, systolic:0, diastolic:0, vexusGrade:-1}; dataIndex=0;
        logContainer.innerHTML = ''; debriefContent.textContent = ''; scenarioLog = [];
        
        // Show/hide HOCM override button
        if (scenarioName === 'hocm') {
            buttons.hocmOverride.classList.remove('hidden');
        } else {
            buttons.hocmOverride.classList.add('hidden');
        }

        document.querySelectorAll('.panel.collapsed').forEach(panel => {
            const content = panel.querySelector('.panel-content');
            if (content) {
                content.style.maxHeight = null;
            }
        });
        
        Object.values(charts).forEach(c=>{c.data.datasets[0].data=[];c.update('none');});
        updateDisplay(); 
        logAction('system', `Scenario loaded: ${scenarioName.replace(/([A-Z])/g, ' $1').trim()}`);
        simulationInterval = setInterval(simulationTick, SIMULATION_TICK_MS);
    }
    
    window.onload = () => {
        setupCharts();
        setupEventListeners();
        loadScenario('normal');
    };

    </script>
</body>
</html>

